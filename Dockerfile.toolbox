FROM python:3.13-slim

# -------- Setup base system --------
WORKDIR /app

# Install system tools: curl, unzip, build-essential (for compiling Python packages)
RUN apt-get update && \
    apt-get install -y curl unzip build-essential && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# -------- Install AWS CLI --------
RUN curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && \
    unzip awscliv2.zip && \
    ./aws/install && \
    rm -rf awscliv2.zip aws/

# Check AWS CLI version
RUN aws --version

# -------- Install Toolbox binary --------
ARG TOOLBOX_VERSION=0.4.0
ARG OS=linux/amd64
RUN mkdir /toolbox-bin && \
    cd /toolbox-bin && \
    curl -O https://storage.googleapis.com/genai-toolbox/v${TOOLBOX_VERSION}/${OS}/toolbox && \
    chmod +x toolbox

# -------- Install Python dependencies --------
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# -------- Copy app code --------
COPY . .

# ENV AWS_DEFAULT_REGION="us-east-1"

# -------- Configure AWS CLI --------
# AWS CLI picks up credentials from environment variables
# Set default output format
# RUN aws configure set output json
# Add access key, secret key, and region configuration
# -------- Expose ports --------
EXPOSE 4100 4000

# -------- Start both processes --------
# You can use a small script or `bash -c` to launch both the Python app and Toolbox

CMD bash -c "/toolbox-bin/toolbox serve --tools_file /app/config.yaml --port 4000 --address 0.0.0.0 & python app_live.py"
